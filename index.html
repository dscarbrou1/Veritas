import React, { useState, useEffect, useCallback, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, getDoc } from 'firebase/firestore';

// --- GLOBAL VARIABLES (Provided by Environment) ---
// Note: These must be declared as if they are imported globals for React environment to recognize them.
// We provide fallbacks for local testing if the variables are not defined.
const __app_id = typeof window !== 'undefined' && window.__app_id ? window.__app_id : 'default-app-id';
const __firebase_config = typeof window !== 'undefined' && window.__firebase_config ? JSON.parse(window.__firebase_config) : null;
const __initial_auth_token = typeof window !== undefined && window.__initial_auth_token ? window.__initial_auth_token : null;

// --- API CONFIGURATION ---
const DICTIONARY_API_URL = "https://api.dictionaryapi.dev/api/v2/entries/en/";
// PASTE USER'S WORKING GEMINI KEY HERE
const GEMINI_API_KEY = "AIzaSyDraNdjH386L-xPRwPD7VDZejiQPfI_7BM"; 
const GEMINI_API_URL = "https://generativelangugage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=" + GEMINI_API_KEY;

// --- STATIC DATA ---
const RANDOM_WORDS = [
    "ubiquitous", "ephemeral", "serendipity", "mellifluous", "quixotic",
    "cacophony", "epiphany", "eloquence", "incongruous", "plethora",
    "juxtaposition", "voracious", "equivocate", "nebulous", "resilience",
    "sycophant", "taciturn", "veracity", "zephyr"
];
const MAX_HISTORY = 10;

// --- FIREBASE SETUP ---
let db;
let auth;

// --- UTILITY/HOOKS (Defined outside App for single declaration) ---

const getPartofSpeechColor = (partOfSpeech) => {
    switch (partOfSpeech.toLowerCase()) {
        case 'noun': return 'bg-indigo-100 text-indigo-700';
        case 'verb': return 'bg-green-100 text-green-700';
        case 'adjective': return 'bg-yellow-100 text-yellow-700';
        case 'adverb': return 'bg-pink-100 text-pink-700';
        default: return 'bg-gray-100 text-gray-700';
    }
};

const cleanAndParseJson = (jsonText) => {
    let cleanedText = jsonText.trim();
    cleanedText = cleanedText.replace(/```(json)?/g, '').trim();
    try {
        return JSON.parse(cleanedText);
    } catch (e) {
        console.error("Failed to parse cleaned JSON:", e);
        return null;
    }
};


// --- COMPONENT DEFINITIONS ---

// Pronunciation Tester Component
const PronunciationTester = ({ correctWord }) => {
    const [isListening, setIsListening] = useState(false);
    const [result, setResult] = useState(null); // 'success', 'fail', or null
    const recognition = useRef(null);

    // Check for browser support
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    useEffect(() => {
        if (SpeechRecognition) {
            recognition.current = new SpeechRecognition();
            recognition.current.continuous = false;
            recognition.current.lang = 'en-US';
            recognition.current.interimResults = false;
            recognition.current.maxAlternatives = 1;

            recognition.current.onresult = (event) => {
                const spokenWord = event.results[0][0].transcript.toLowerCase().trim();
                const cleanCorrectWord = correctWord.toLowerCase().trim();

                if (spokenWord === cleanCorrectWord) {
                    setResult('success');
                } else {
                    setResult('fail');
                }
                setIsListening(false);
            };

            recognition.current.onerror = (event) => {
                console.error("Speech Recognition Error:", event.error);
                setResult('error');
                setIsListening(false);
            };

            recognition.current.onend = () => {
                // Only set listening to false if we didn't get a result, or if we weren't cancelled
                if (isListening && result === null) {
                    setIsListening(false);
                }
            };
        }
        return () => {
            if (recognition.current) {
                recognition.current.stop();
            }
        };
    }, [correctWord, isListening, SpeechRecognition]);

    const startListening = () => {
        if (!SpeechRecognition) {
            setResult('unsupported');
            return;
        }
        setResult(null);
        setIsListening(true);
        recognition.current.start();
    };

    const buttonStyle = isListening ? 'bg-red-500 hover:bg-red-600' : 'bg-indigo-500 hover:bg-indigo-600';
    
    let resultMessage = null;
    if (result === 'success') {
        resultMessage = <span className="text-green-600 font-semibold flex items-center mt-2">
            <svg className="h-5 w-5 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" /></svg>
            Pronunciation Perfect!
        </span>;
    } else if (result === 'fail') {
        resultMessage = <span className="text-red-500 font-semibold flex items-center mt-2">
            <svg className="h-5 w-5 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" /></svg>
            Try Again.
        </span>;
    } else if (result === 'error' || result === 'unsupported') {
            resultMessage = <span className="text-yellow-600 font-semibold flex items-center mt-2">Microphone/Speech API Error.</span>;
    }

    return (
        <div className="p-4 mt-6 bg-gray-50 rounded-lg border border-gray-200 flex items-center justify-between">
            <div>
                <button 
                    onClick={startListening}
                    className={`text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ${buttonStyle}`}
                    disabled={isListening}
                >
                    {isListening ? 'Listening...' : 'Test Pronunciation'}
                </button>
                {resultMessage}
            </div>
            <div className="text-sm text-gray-500 italic">
                {result === 'unsupported' && "Speech Recognition is not supported by your browser."}
            </div>
        </div>
    );
};

// AI Examples Component (Handles its own loading and API call)
const AiExamples = React.memo(({ word, definition }) => {
    const [examples, setExamples] = useState(null);

    // Call API only when word/definition changes
    useEffect(() => {
        const fetchExamples = async () => {
            const systemPrompt = `You are a helpful linguistic assistant. Analyze the provided word and definition. Generate exactly two unique, clear, and modern example sentences using the word. The examples must not contain the word's definition. Output ONLY the two sentences, separated by a newline character.`;
            const userQuery = `Word: ${word}. Definition: ${definition}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                config: { temperature: 0.7 }
            };

            try {
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "AI analysis failed.";
                setExamples(text.split('\n').filter(s => s.trim().length > 0));

            } catch (e) {
                console.error("Gemini API call failed:", e);
                setExamples(["AI Examples: Error generating content."]);
            }
        };
        fetchExamples();
    }, [word, definition]);

    if (!examples) return (
        <div className="p-4 mt-8 bg-blue-50 rounded-lg border border-blue-200">
            <h3 className="text-lg font-bold text-blue-700 mb-2 flex items-center">AI Contextual Examples</h3>
            <div className="text-sm text-gray-500 italic flex items-center">
                <svg className="animate-spin h-4 w-4 mr-1 text-blue-500" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" fill="none" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Generating custom examples...
            </div>
        </div>
    );

    return (
        <div className="p-4 mt-8 bg-blue-50 rounded-lg border border-blue-200">
            <h3 className="text-lg font-bold text-blue-700 mb-2 flex items-center">AI Contextual Examples</h3>
            <ul className="list-disc list-inside space-y-1 ml-4 text-gray-600">
                {examples.map((ex, index) => (
                    <li key={index} className="text-base">{ex}</li>
                ))}
            </ul>
        </div>
    );
});


// Component to handle the entire application logic and rendering
const App = () => {
    // --- STATE MANAGEMENT ---
    const [searchTerm, setSearchTerm] = useState('');
    const [wordData, setWordData] = useState(null);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);
    const [aiEnabled, setAiEnabled] = useState(true);
    
    // Firestore State
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [settingsLoading, setSettingsLoading] = useState(true);

    const [history, setHistory] = useState(() => JSON.parse(localStorage.getItem('wordHistory')) || []);

    // Refs for DOM manipulation/focus
    const inputRef = useRef(null);
    const historyRef = useRef(null);
    const historyTimeoutRef = useRef(null);
    
    // --- FIREBASE & AUTH INITIALIZATION ---
    useEffect(() => {
        if (!__firebase_config) {
            console.error("Firebase config is missing. Persistent settings disabled.");
            setIsAuthReady(true);
            setSettingsLoading(false);
            return;
        }

        try {
            const app = initializeApp(__firebase_config);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Sign in anonymously or with custom token
            const handleAuth = async (token) => {
                try {
                    if (token) {
                        await signInAnonymously(auth);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (e) {
                    console.error("Firebase Auth error:", e);
                }
            };
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    setUserId(user.uid);
                    setIsAuthReady(true);
                } else {
                    handleAuth(__initial_auth_token);
                }
            });

        } catch (e) {
            console.error("Firebase initialization failed:", e);
            setIsAuthReady(true);
            setSettingsLoading(false);
        }
    }, []);

    // --- FIRESTORE PERSISTENCE LOGIC ---
    
    const settingsPath = `artifacts/${__app_id}/users/${userId}/settings/prefs`;

    // 1. Load settings from Firestore
    useEffect(() => {
        const loadSettings = async () => {
            if (isAuthReady && userId && db) {
                try {
                    const docRef = doc(db, settingsPath);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.aiEnabled !== undefined) {
                            setAiEnabled(data.aiEnabled);
                        }
                    }
                } catch (e) {
                    console.error("Error loading settings:", e);
                } finally {
                    setSettingsLoading(false);
                }
            }
        };
        // ONLY call loadSettings if auth is ready and userId is set
        if (isAuthReady && userId) {
            loadSettings();
        }
    }, [isAuthReady, userId]);

    // 2. Save settings to Firestore
    const saveSettings = useCallback(async (newAiEnabled) => {
        if (userId && db) {
            setSettingsLoading(true);
            try {
                const docRef = doc(db, settingsPath);
                await setDoc(docRef, { aiEnabled: newAiEnabled }, { merge: true });
            } catch (e) {
                console.error("Error saving settings:", e);
            } finally {
                setSettingsLoading(false);
            }
        }
    }, [userId]);

    // --- UI/UTILITY LOGIC ---

    const handleAiToggle = useCallback((enable) => {
        setAiEnabled(enable);
        saveSettings(enable);
    }, [saveSettings]);
    
    // Save to LocalStorage History (still useful as fallback/recency)
    const saveToHistory = useCallback((word) => {
        let newHistory = history.filter(w => w !== word);
        newHistory.unshift(word);
        newHistory = newHistory.slice(0, MAX_HISTORY);
        setHistory(newHistory);
        localStorage.setItem('wordHistory', JSON.stringify(newHistory));
    }, [history]);

    // --- SEARCH LOGIC ---

    const performSearch = useCallback(async (word) => {
        const searchTerm = (word || inputRef.current.value).trim().toLowerCase();
        if (!searchTerm) return;

        setLoading(true);
        setError(null);
        setWordData(null);
        
        try {
            const response = await fetch(`${DICTIONARY_API_URL}${searchTerm}`);
            
            if (response.status === 404) {
                setError(`Word not found: "${searchTerm}"`);
                return;
            }
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            
            if (Array.isArray(data) && data.length > 0) {
                setWordData(data);
                saveToHistory(data[0].word);
            } else {
                setError(`No definition found for "${searchTerm}"`);
            }

        } catch (e) {
            console.error('Fetch Error:', e);
            setError(`An unexpected network error occurred.`);
        } finally {
            setLoading(false);
        }
    }, [saveToHistory]);
    
    // --- HISTORY/DROPDOWN LOGIC ---
    
    const handleInputFocus = () => {
        if (historyRef.current) {
            if (inputRef.current.value === '') {
                historyRef.current.classList.remove('hidden');
            }
        }
    };

    const handleInputBlur = () => {
        // Use a timeout to allow click event on dropdown items to fire before hiding
        historyTimeoutRef.current = setTimeout(() => {
            if (historyRef.current) {
                historyRef.current.classList.add('hidden');
            }
        }, 150);
    };

    const handleRandomSearch = () => {
        const randomIndex = Math.floor(Math.random() * RANDOM_WORDS.length);
        const word = RANDOM_WORDS[randomIndex];
        performSearch(word);
    };
    
    const handleClearHistory = () => {
        localStorage.removeItem('wordHistory');
        setHistory([]);
    };

    // --- RENDERING COMPONENTS ---

    const AiToggleComponent = (
        <div className="flex p-1 bg-gray-200 rounded-lg shadow-inner items-center">
            <button 
                onClick={() => handleAiToggle(true)}
                className={`px-3 py-1 rounded-md text-sm font-bold transition ${aiEnabled ? 'toggle-active' : 'toggle-inactive'}`}
                disabled={settingsLoading}
            >
                AI Examples ON
            </button>
            <button 
                onClick={() => handleAiToggle(false)}
                className={`px-3 py-1 rounded-md text-sm font-bold transition ${!aiEnabled ? 'toggle-active' : 'toggle-inactive'}`}
                disabled={settingsLoading}
            >
                AI Examples OFF
            </button>
            {settingsLoading && (
                <div className="ml-2 text-xs text-gray-500 flex items-center">
                    <svg className="animate-spin h-3 w-3 mr-1 text-gray-500" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Saving...
                </div>
            )}
        </div>
    );
    
    // Dropdown (History/Suggestions)
    const DropdownComponent = () => {
        let items = [];
        let title = "Recent Searches";
        
        // Show Suggestions if typing
        if (inputRef.current && inputRef.current.value) {
            const lowerQuery = inputRef.current.value.toLowerCase();
            items = RANDOM_WORDS.filter(word => 
                word.toLowerCase().includes(lowerQuery)
            ).slice(0, 10);
            title = "Suggestions";
        } else {
            items = history;
        }

        if (items.length === 0 && !inputRef.current?.value) return null;

        return (
            <div ref={historyRef} className="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-xl max-h-48 overflow-y-auto" style={{ top: '0px' }}>
                <div className="flex justify-between items-center p-2 border-b text-gray-500 text-xs font-semibold">
                    <span id="dropdownTitle">{title}</span>
                    <button onClick={handleClearHistory} className="text-red-500 hover:text-red-700 font-bold px-2 py-1 rounded transition duration-150">
                        Clear
                    </button>
                </div>
                <div id="dropdownList">
                    {items.map((item, index) => (
                        <div 
                            key={index}
                            className="p-2 cursor-pointer hover:bg-blue-50 transition text-gray-800"
                            // Use onMouseDown to prevent blur before click registers
                            onMouseDown={() => {
                                inputRef.current.value = item;
                                historyRef.current.classList.add('hidden');
                                performSearch(item);
                            }}
                        >
                            {item}
                        </div>
                    ))}
                </div>
            </div>
        );
    };
    
    // Main Content Renderer
    const MeaningSectionComponent = ({ data }) => {
        const firstEntry = data[0];
        
        // Find best audio link and phonetic text
        let phonetic = '';
        let audioUrl = '';
        for (const entry of data) {
            if (entry.phonetics && entry.phonetics.length > 0) {
                const phoneticEntry = entry.phonetics.find(p => p.audio && p.audio.length > 0) || entry.phonetics[0];
                if (phoneticEntry) {
                    phonetic = phoneticEntry.text || '';
                    audioUrl = phoneticEntry.audio.startsWith('//') ? 'https:' + phoneticEntry.audio : phoneticEntry.audio;
                    break;
                }
            }
        }
        
        // Etymology
        const etymologies = firstEntry.origin || data.map(d => d.origin).flat().filter(o => o);
        
        // Word Forms / Inflections
        // Collects all unique word and phonetic variations from the entire API response
        const allWords = data.map(entry => entry.word).filter(Boolean);
        const allPhonetics = data.map(entry => entry.phonetic).filter(Boolean);
        const forms = [...new Set([...allWords, ...allPhonetics])].filter(v => v !== firstEntry.word);

        return (
            <div id="wordCard">
                <h2 className="text-4xl font-bold text-gray-900 mb-2">{firstEntry.word}</h2>
                
                {/* Pronunciation Test Section */}
                {isAuthReady && <PronunciationTester correctWord={firstEntry.word} />}


                {/* Phonetics and Audio */}
                <div className="flex items-center space-x-3 mt-6 mb-6 text-gray-600">
                    <span className="text-lg italic">{phonetic}</span>
                    <button 
                        onClick={() => playAudio(audioUrl)}
                        className="text-blue-500 hover:text-blue-700 transition transform hover:scale-110" 
                        title="Listen to pronunciation">
                        <svg className="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                            <path fillRule="evenodd" d="M9.383 3.064A1 1 0 0110 3v14a1 1 0 01-.617.936l-3.5 1.5a1 1 0 01-1.383-.936V2.5a1 1 0 01.936-.936l3.5 1.5zM15 8.5a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zm-4 0a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1z" clipRule="evenodd" />
                        </svg>
                    </button>
                </div>

                {/* Etymology Card */}
                {etymologies.length > 0 && (
                    <div className="p-4 mb-6 bg-gray-50 rounded-lg border border-gray-200">
                        <h3 className="text-lg font-bold text-gray-700 mb-2 flex items-center">
                            <svg className="h-5 w-5 mr-2 text-indigo-500" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2.586l.293.293a1 1 0 001.414 0l7-7a1 1 0 000-1.414l-7-7z" />
                            </svg>
                            Word Origin (Etymology)
                        </h3>
                        <p className="text-sm text-gray-600 italic" dangerouslySetInnerHTML={{ __html: etymologies[0] }} />
                    </div>
                )}
                
                {/* Word Forms / Inflections Card */}
                {forms.length > 0 && (
                    <div className="p-4 mt-8 bg-indigo-50 rounded-lg border border-indigo-200">
                        <h3 className="text-lg font-bold text-indigo-700 mb-3 flex items-center">
                            <svg className="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7z" />
                                <path fillRule="evenodd" d="M18 6a2 2 0 012 2v10a2 2 0 01-2 2H2a2 2 0 01-2-2V8a2 2 0 012-2h1.586a1 1 0 01.707.293L6 8.586V13a1 1 0 001 1h6a1 1 0 001-1V8.586l1.707-1.707a1 1 0 01.707-.293H18zm-5 6H7v-4h6v4z" clipRule="evenodd" />
                            </svg>
                            Word Forms / Inflections
                        </h3>
                        <div className="flex flex-wrap gap-2">
                            {forms.map((form, index) => (
                                <span key={index} className="word-form-tag">{form}</span>
                            ))}
                        </div>
                    </div>
                )}

                {/* Meanings and Definitions */}
                <div className="space-y-8 mt-8">
                    {data.map(entry => entry.meanings || []).flat().map((meaning, meaningIndex) => {
                        const colorClass = getPartofSpeechColor(meaning.partOfSpeech);
                        let firstMeaningDefinition = ''; 
                        
                        return (
                            <div key={meaningIndex} className="p-4 bg-white rounded-lg shadow-md border border-gray-100">
                                <h3 className="text-xl font-bold mb-3">
                                    <span className={`part-of-speech ${colorClass}`}>{meaning.partOfSpeech}</span>
                                </h3>
                                
                                {/* Definitions */}
                                <ul className="list-disc list-inside space-y-2 mb-4 ml-4 text-gray-700">
                                    {meaning.definitions.slice(0, 3).map((def, defIndex) => {
                                        if (defIndex === 0) firstMeaningDefinition = def.definition;
                                        return (
                                            <li key={defIndex} className="text-base">
                                                <span className="font-medium text-gray-800">{def.definition}</span>
                                                {def.example && (
                                                    <p className="text-sm italic text-gray-500 mt-1">Example: "{def.example}"</p>
                                                )}
                                            </li>
                                        );
                                    })}
                                </ul>
                                
                                {/* Synonyms and Antonyms */}
                                {meaning.synonyms?.length > 0 && (
                                    <div className="mt-4">
                                        <p className="text-sm font-semibold text-gray-700">Synonyms:</p>
                                        <div className="scroll-list flex flex-wrap gap-2 pt-1">
                                            {meaning.synonyms.map((w, index) => (
                                                <a key={index} href="#" className="text-blue-500 hover:text-blue-700 text-sm font-medium transition underline" onMouseDown={() => performSearch(w)}>
                                                    {w}
                                                </a>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                
                                {meaning.antonyms?.length > 0 && (
                                    <div className="mt-2">
                                        <p className="text-sm font-semibold text-gray-700">Antonyms:</p>
                                        <div className="scroll-list flex flex-wrap gap-2 pt-1">
                                            {meaning.antonyms.map((w, index) => (
                                                <a key={index} href="#" className="text-red-500 hover:text-red-700 text-sm font-medium transition underline" onMouseDown={() => performSearch(w)}>
                                                    {w}
                                                </a>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                
                                {/* AI Contextual Examples */}
                                {meaningIndex === 0 && aiEnabled && firstMeaningDefinition && (
                                    <AiExamples word={firstEntry.word} definition={firstMeaningDefinition} />
                                )}
                            </div>
                        );
                    })}
                </div>
            </div>
        );
    };

    // AI Examples Component (Handles its own loading and API call)
    const AiExamples = React.memo(({ word, definition }) => {
        const [examples, setExamples] = useState(null);

        useEffect(() => {
            const fetchExamples = async () => {
                const result = await generateAiExamples(word, definition);
                setExamples(result);
            };
            fetchExamples();
        }, [word, definition]);

        if (!aiEnabled) return null;
        if (!examples) return (
            <div className="p-4 mt-8 bg-blue-50 rounded-lg border border-blue-200">
                <h3 className="text-lg font-bold text-blue-700 mb-2 flex items-center">AI Contextual Examples</h3>
                <div className="text-sm text-gray-500 italic flex items-center">
                    <svg className="animate-spin h-4 w-4 mr-1 text-blue-500" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Generating custom examples...
                </div>
            </div>
        );

        return (
            <div className="p-4 mt-8 bg-blue-50 rounded-lg border border-blue-200">
                <h3 className="text-lg font-bold text-blue-700 mb-2 flex items-center">AI Contextual Examples</h3>
                <ul className="list-disc list-inside space-y-1 ml-4 text-gray-600">
                    {examples.map((ex, index) => (
                        <li key={index} className="text-base">{ex}</li>
                    ))}
                </ul>
            </div>
        );
    });

    // --- MAIN APPLICATION COMPONENT ---
    return (
        <div className="container bg-white p-6 md:p-8 rounded-xl shadow-2xl">
            {/* Header */}
            <header className="text-center mb-6">
                <h1 className="text-3xl font-extrabold text-gray-800">Veritas</h1>
                <p className="text-sm text-gray-500">Your comprehensive digital lexicon.</p>
            </header>

            {/* Search Input and Controls */}
            <div className="flex flex-wrap gap-3 mb-4">
                <div className="flex-grow relative">
                    <input 
                        type="text" 
                        ref={inputRef}
                        onFocus={handleInputFocus}
                        onBlur={handleInputBlur}
                        onKeyDown={(e) => { if (e.key === 'Enter') performSearch(); }}
                        className={`w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 shadow-inner ${error ? 'border-red-500' : ''}`}
                        placeholder="Search for a word..."
                    />
                    <div className="absolute z-10 w-full" style={{ top: '100%', left: 0 }}>
                        <DropdownComponent />
                    </div>
                </div>
                
                <button 
                    onClick={() => performSearch()}
                    className="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-150 transform hover:scale-105 active:scale-95 flex items-center justify-center"
                    disabled={loading}
                >
                    {loading ? (
                        <svg className="animate-spin h-5 w-5 text-white" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" fill="none" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    ) : 'Search'}
                </button>

                <button 
                    onClick={handleRandomSearch}
                    className="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-150 transform hover:scale-105 active:scale-95 flex items-center justify-center"
                    title="Random Word"
                    disabled={loading}
                >
                    <svg className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fillRule="evenodd" d="M10 2.5a7.5 7.5 0 100 15 7.5 7.5 0 000-15zM8.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4a1 1 0 00-1.414-1.414L10 10.586l-1.293-1.293z" clipRule="evenodd" />
                        </svg>
                    </button>
            </div>

            {/* AI Toggle and Message Area */}
            <div className="flex justify-between items-center mb-6">
                {AiToggleComponent}
                {error && <div className="text-sm text-red-500 font-medium">{error}</div>}
            </div>

            {/* Results Display Area */}
            <div id="resultsArea">
                {/* Initial/Welcome State */}
                {!wordData && !error && !loading && (
                    <div id="welcomeMessage" className="text-center p-8 border border-gray-200 rounded-xl">
                        <h2 className="text-2xl font-bold text-gray-800 mb-2">Start Exploring Vocabulary!</h2>
                        <p className="text-gray-600">Type a word above or click the shuffle button to begin your search.</p>
                    </div>
                )}

                {/* Word Not Found State */}
                {error && !wordData && error.includes('not found') && (
                    <div id="noResults" className="text-center p-8 border-4 border-dashed border-red-200 bg-red-50 rounded-xl">
                        <h2 className="text-2xl font-bold text-red-700 mb-3">Word Not Found</h2>
                        <p className="text-gray-600 mb-4">We couldn't find a definition for that word. Please check your spelling.</p>
                        <button onClick={handleRandomSearch} className="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition shadow-md">
                            Try a Random Word
                        </button>
                    </div>
                )}

                {/* Word Definition Card (Main Content) */}
                {wordData && <MeaningSectionComponent data={wordData} />}
            </div>
            
            {/* Footer/Source */}
            <footer className="mt-8 text-center text-xs text-gray-400 border-t pt-4">
                Data provided by the Free Dictionary API. AI content generated by Google Gemini.
            </footer>
        </div>
    );
};

export default App;




